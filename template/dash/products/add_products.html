{% extends "dash/base.html" %}
{% block 'title' %}Add Product{% endblock 'title' %}

{% block 'css' %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock 'css' %}

{% block 'body' %}
<div class="container-fluid">

  <h4 class="py-3">Create New Product</h4>

  <div class="card">
    <div class="card-body">

      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Title -->
        <div class="mb-3">
          <label class="form-label">Product Title</label>
          <input type="text" class="form-control" name="title" required>
        </div>

        <!-- Category -->
        <div class="mb-3">
          <label class="form-label">Select Category</label>
          <select class="form-select" name="category" required>
            {% for i in categories %}
            <option value="{{ i.id }}">{{ i.title }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Meta Title -->
        <div class="mb-3">
          <label class="form-label">Meta Title</label>
          <input type="text" class="form-control" name="meta_title">
        </div>

        <!-- Meta Description -->
        <div class="mb-3">
          <label class="form-label">Meta Description</label>
          <textarea class="form-control" rows="2" name="meta_description"></textarea>
        </div>

        <!-- Meta Keywords -->
        <div class="mb-3">
          <label class="form-label">Meta Keywords</label>
          <input type="text" class="form-control" name="meta_keywords" placeholder="comma, separated, keywords">
        </div>

        <!-- SPECS START -->
        <h5 class="mt-4 mb-2">Product Specifications</h5>

        {% for n in "12345" %}
        <div class="row mb-2">
          <div class="col-md-6">
            <input type="text" class="form-control" name="spec{{n}}heading" placeholder="Specification {{n}} Heading">
          </div>
          <div class="col-md-6">
            <input type="text" class="form-control" name="spec{{n}}answer" placeholder="Specification {{n}} Answer">
          </div>
        </div>
        {% endfor %}
        <!-- SPECS END -->

        <!-- Thumbnail -->
        <div class="mb-3 mt-3">
          <label class="form-label">Thumbnail Image</label>
          <input type="file" class="form-control" name="thumbnail" accept="image/*" required>
        </div>

        <!-- CONTENT -->
        <div class="mb-3">
          <label class="form-label">Product Description</label>

          <!-- Toolbar -->
          <div id="quill-toolbar">
            <span class="ql-formats">
              <button class="ql-bold"></button>
              <button class="ql-italic"></button>
              <button class="ql-underline"></button>
            </span>

            <span class="ql-formats">
              <button class="ql-list" value="ordered"></button>
              <button class="ql-list" value="bullet"></button>
              <button class="ql-link"></button>
              <button class="ql-image"></button>
            </span>
          </div>

          <div id="editor" style="height: 300px;"></div>
          <input type="hidden" name="content" id="hiddenContentInput">
        </div>

        <button class="btn btn-primary">Save Product</button>
      </form>

    </div>
  </div>

</div>

<!-- Quill -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
var csrfToken = "{{ csrf_token }}";

var quill = new Quill("#editor", {
  theme: "snow",
  modules: {
    toolbar: {
      container: "#quill-toolbar",
      handlers: {
        "image": function () {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.click();

          input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("image", file);

            const res = await fetch("/upload_quill_image/", {
              method: "POST",
              headers: { "X-CSRFToken": csrfToken },
              body: formData,
            });

            const data = await res.json();
            const range = quill.getSelection(true);
            quill.insertEmbed(range.index, "image", data.url);
          };
        }
      }
    }
  }
});

document.querySelector("form").onsubmit = function () {
  document.getElementById("hiddenContentInput").value = quill.root.innerHTML;
};
</script>

{% endblock 'body' %}
