{% extends "dash/base.html" %}

{% block 'title' %} Edit Article — {{ article.title }} {% endblock 'title' %}

{% block 'css' %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock 'css' %}

{% block 'body' %}
<div class="container-fluid">

    <div class="py-3 d-flex align-items-center">
        <h4 class="fs-18 fw-semibold m-0">Edit Article</h4>
    </div>

    <div class="row">

        <div class="col-xl-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Edit: {{ article.title }}</h5>
                </div>

                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Title -->
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" name="title" value="{{ article.title }}" required>
                        </div>

                        <!-- Meta Title -->
                        <div class="mb-3">
                            <label class="form-label">Meta Title</label>
                            <input type="text" class="form-control" name="meta_title" value="{{ article.meta_title }}">
                        </div>

                        <!-- Meta Description -->
                        <div class="mb-3">
                            <label class="form-label">Meta Description</label>
                            <textarea class="form-control" rows="2" name="meta_description">{{ article.meta_description }}</textarea>
                        </div>

                        <!-- Meta Keywords -->
                        <div class="mb-3">
                            <label class="form-label">Meta Keywords</label>
                            <input type="text" class="form-control" name="meta_keywords" value="{{ article.meta_keywords }}">
                        </div>

                        <!-- Thumbnail Upload -->
                        <div class="mb-3">
                            <label class="form-label">Thumbnail Image</label>
                            <input type="file" class="form-control" name="thumbnail" accept="image/*">

                            {% if article.thumbnail %}
                                <p class="mt-2">Current:</p>
                                <img src="{{ article.thumbnail.url }}" style="max-width:200px; border-radius:8px;">
                            {% endif %}
                        </div>

                        <!-- CONTENT -->
                        <div class="mb-3">
                            <label class="form-label">Content</label>

                            <!-- Toolbar -->
                            <div id="quill-toolbar">
                                <span class="ql-formats">
                                    <button class="ql-bold"></button>
                                    <button class="ql-italic"></button>
                                    <button class="ql-underline"></button>
                                </span>

                                <span class="ql-formats">
                                    <button class="ql-list" value="ordered"></button>
                                    <button class="ql-list" value="bullet"></button>
                                    <button class="ql-link"></button>
                                    <button class="ql-image"></button>
                                </span>
                            </div>

                            <!-- Editor -->
                            <div id="editor" style="height: 300px;">{{ article.content|safe }}</div>
                            <input type="hidden" id="hiddenContentInput" name="content">
                        </div>

                        <!-- SUBMIT -->
                        <div class="mt-3">
                            <button class="btn btn-primary">Save Changes</button>
                            <a href="/dashboard/articles/" class="btn btn-secondary">Cancel</a>
                        </div>

                    </form>
                </div>
            </div>
        </div>

        <!-- HELP PANEL -->
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Help</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Update the article details here.  
                        Thumbnail is optional — if left empty, existing one is kept.
                    </p>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Quill Scripts -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
var csrfToken = "{{ csrf_token }}";

var quill = new Quill("#editor", {
    theme: "snow",
    modules: {
        toolbar: {
            container: "#quill-toolbar",
            handlers: {
                "image": function () {
                    const input = document.createElement("input");
                    input.type = "file";
                    input.accept = "image/*";
                    input.click();

                    input.onchange = async () => {
                        const file = input.files[0];
                        if (!file) return;

                        const formData = new FormData();
                        formData.append("image", file);

                        const res = await fetch("/upload_quill_image/", {
                            method: "POST",
                            headers: { "X-CSRFToken": csrfToken },
                            body: formData,
                        });

                        const data = await res.json();
                        if (data.url) {
                            const range = quill.getSelection(true);
                            quill.insertEmbed(range.index, "image", data.url);
                        }
                    };
                }
            }
        }
    }
});

// Push Quill content into hidden field
document.querySelector("form").onsubmit = function () {
    document.getElementById("hiddenContentInput").value = quill.root.innerHTML;
};
</script>

{% endblock 'body' %}
